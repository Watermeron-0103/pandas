
---

```markdown
# 不良カテゴリ別シート分割スクリプト（備忘録）— 完成版（円グラフ埋め込みあり）

## 目的
元ファイル **「不適合の表_2025101-20250703.xlsx」** のデータを、列 **「不良カテゴリ」** ごとに分割し、**カテゴリ名ごとのシート**を持つ新しい Excel ブックを作成する。  
先頭には **カテゴリ一覧（件数・割合）** と、各カテゴリシートへジャンプできる **ハイパーリンク**、さらに **円グラフ（件数＋%表示）** を埋め込む。

## 前提
- Python 3.9+
- 必要ライブラリ: `pandas`, `xlsxwriter`
  - インストール: `pip install pandas xlsxwriter`
- 入力 Excel のシート名は **「総合183」** を想定（必要に応じて変更）
- データに **「不良カテゴリ」** 列が存在すること

## フォルダ構成（例）
```

inspection\_scripts/
├─ カテゴリ分割.py
└─ 不良カテゴリ別シート分割\_備忘録.md  ← 本ファイル

````

## 使い方
1. 下記の **完成版ソース** を `inspection_scripts/カテゴリ分割.py` として保存。
2. 入力ファイル `不適合の表_2025101-20250703.xlsx` を同じフォルダ（または適切なパスへ修正）。
3. 実行：
   ```bash
   python カテゴリ分割.py
````

4. 出力：`out/不良カテゴリ別_ブック.xlsx`

   * **カテゴリ一覧** … 件数・割合・各カテゴリへのジャンプリンク・**円グラフ（件数＋%）**
   * **カテゴリ別シート** … 該当レコードのみ、オートフィルタ、1行固定、簡易オートフィット

---

## 完成版ソース（カテゴリ分割.py）

```python
import os
import re
import pandas as pd

# === 入出力設定 ===
SRC_FILE = "不適合の表_2025101-20250703.xlsx"   # 入力Excel
SRC_SHEET = "総合183"                          # 読み込みシート名
OUT_DIR   = "out"
OUT_FILE  = os.path.join(OUT_DIR, "不良カテゴリ別_ブック.xlsx")

os.makedirs(OUT_DIR, exist_ok=True)

# === ユーティリティ ===
def sanitize_sheet_name(name: str) -> str:
    """
    Excelのシート名に使えない文字を除去、31文字制限、空なら'Sheet'
    """
    name = re.sub(r'[:\\/\\?\\*\\[\\]]', '_', str(name))
    name = name.replace("'", "’")
    name = name.strip() or "Sheet"
    return name[:31]

def unique_name(base: str, used: set) -> str:
    """同名シート回避（_2, _3 ... を付与）"""
    name = base
    i = 2
    while name in used:
        suffix = f"_{i}"
        name = (base[:(31 - len(suffix))] + suffix) if len(base) + len(suffix) > 31 else base + suffix
        i += 1
    used.add(name)
    return name

def best_fit_widths(df: pd.DataFrame, max_width=60):
    """簡易オートフィット（先頭500行の文字数から概算）"""
    widths = []
    sample = df.head(500)
    for col in df.columns:
        max_len = max([len(str(col))] + [len(str(v)) for v in sample[col].tolist()])
        widths.append(min(max_len + 2, max_width))  # 全角考慮で+2
    return widths

# === データ読み込み ===
df = pd.read_excel(SRC_FILE, sheet_name=SRC_SHEET)
df = df.copy()
df["不良カテゴリ"] = df["不良カテゴリ"].astype(str)
df = df[df["不良カテゴリ"].notna() & (df["不良カテゴリ"].str.strip() != "")]

# === 集計（件数・割合） ===
counts = df["不良カテゴリ"].value_counts(dropna=False)
total = int(counts.sum())
summary = (
    counts.rename("件数")
    .to_frame()
    .assign(割合=lambda x: (x["件数"] / total * 100).round(1))
    .reset_index()
    .rename(columns={"index": "不良カテゴリ"})
)

# === Excel書き出し ===
with pd.ExcelWriter(OUT_FILE, engine="xlsxwriter") as writer:
    workbook  = writer.book

    # 1) 一覧シート
    summary_sheet = "カテゴリ一覧"
    summary.to_excel(writer, index=False, sheet_name=summary_sheet)
    ws_summary = writer.sheets[summary_sheet]

    # 列幅調整
    widths = best_fit_widths(summary)
    for i, w in enumerate(widths):
        ws_summary.set_column(i, i, w)

    # 数値書式
    fmt_int = workbook.add_format({"num_format": "#,##0"})
    fmt_pct = workbook.add_format({"num_format": "0.0\"%\""})
    ws_summary.set_column(1, 1, None, fmt_int)  # 件数
    ws_summary.set_column(2, 2, None, fmt_pct)  # 割合

    # 2) カテゴリごとにシート作成 + ジャンプリンク
    used_names = set()
    link_col = 3
    ws_summary.write(0, link_col, "シートへ")

    for r, row in summary.iterrows():
        category = row["不良カテゴリ"]
        cat_df = df[df["不良カテゴリ"] == category].reset_index(drop=True)

        base = sanitize_sheet_name(category)
        sheet_name = unique_name(base, used_names)

        cat_df.to_excel(writer, index=False, sheet_name=sheet_name)
        ws = writer.sheets[sheet_name]

        # フィルタ・固定・列幅
        ws.autofilter(0, 0, len(cat_df), len(cat_df.columns) - 1)
        ws.freeze_panes(1, 0)
        widths_cat = best_fit_widths(cat_df)
        for i, w in enumerate(widths_cat):
            ws.set_column(i, i, w)

        # 一覧→該当シートA1へジャンプ
        link_formula = f"=HYPERLINK(\"#'{sheet_name}'!A1\",\"→ジャンプ\")"
        ws_summary.write(r + 1, link_col, link_formula)

    # 3) 円グラフ（件数＋% 表示）を一覧シートへ埋め込み
    chart_pie = workbook.add_chart({"type": "pie"})
    last_row = len(summary)  # データ行数
    chart_pie.add_series({
        "categories": [summary_sheet, 1, 0, last_row, 0],  # A列=カテゴリ名
        "values":     [summary_sheet, 1, 1, last_row, 1],  # B列=件数
        "name": "不良カテゴリ割合",
        "data_labels": {
            "value": True,        # 件数
            "percentage": True,   # %
            "separator": "\n",    # 件数と%を改行で表示
            "leader_lines": True  # 引き出し線
        },
    })
    chart_pie.set_title({"name": "不良カテゴリ割合"})
    ws_summary.insert_chart("F2", chart_pie)  # 位置は列幅に応じて調整

    # ヘッダ固定
    ws_summary.freeze_panes(1, 0)

print(f"✅ 出力完了: {OUT_FILE} （{len(summary)}カテゴリ, 合計 {total} 件）")
```

---

## 運用メモ

* **SRC\_FILE / SRC\_SHEET** は環境に合わせて変更可（パスは相対でも絶対でもOK）。
* シート名は **31文字制限**・禁止文字（`: \ / ? * [ ]`）に注意。本スクリプトは自動で置換・短縮。
* **カテゴリが空欄の行も必要**な場合は、フィルタ行（`df = df[...]`）をコメントアウト。
* **列幅の自動調整**は簡易実装（先頭500行をサンプル）。必要なら拡張可能。

## よくある質問

* **Q: 円グラフのラベルが重なる**
  A: Excel側でグラフサイズを少し大きくする、またはカテゴリを統合／「その他」バケット化を検討。
* **Q: 件数順ではなく五十音順にしたい**
  A: `counts = df["不良カテゴリ"].value_counts()` の代わりに
  `summary = df["不良カテゴリ"].value_counts().sort_index()` → 同様に `summary` を整形。

## 変更履歴

* v1.0: 初版（カテゴリ分割、一覧、リンク）
* v1.1: **円グラフ埋め込み** を追加（件数＋%表示、改行表示、引き出し線）

```
