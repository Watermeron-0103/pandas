# 不良カテゴリ別シート分割スクリプト（備忘録）

## 目的
元ファイル **「不適合の表_2025101-20250703.xlsx」** のデータを、列 **「不良カテゴリ」** ごとに分割し、**カテゴリ名ごとのシート**を持つ新しい Excel ブックを作成します。先頭には **カテゴリ一覧（件数・割合）** と、各カテゴリシートへジャンプできる **ハイパーリンク**を用意します。

## 前提
- Python 3.9+
- 必要ライブラリ: `pandas`, `xlsxwriter`（`pip install pandas xlsxwriter`）
- 入力 Excel のシート名は **「総合183」** を想定（変更可）
- データに **「不良カテゴリ」** 列が存在すること

## 使い方
1. 本スクリプトを、入力ファイルと同じフォルダに **`カテゴリ分割.py`** として保存。
2. 実行：
   ```bash
   python カテゴリ分割.py
出力：out/不良カテゴリ別_ブック.xlsx

シート「カテゴリ一覧」 … 各カテゴリの 件数・割合 と ジャンプリンク

各カテゴリの 明細シート … オートフィルタ、1行固定、簡易オートフィット済み

ソースコード（カテゴリ分割）
import os
import re
import pandas as pd

# === 入出力設定 ===
SRC_FILE = "不適合の表_2025101-20250703.xlsx"   # もとのExcel
SRC_SHEET = "総合183"                          # 読み込みシート
OUT_DIR   = "out"
OUT_FILE  = os.path.join(OUT_DIR, "不良カテゴリ別_ブック.xlsx")

os.makedirs(OUT_DIR, exist_ok=True)

# === ユーティリティ ===
def sanitize_sheet_name(name: str) -> str:
    """
    Excelのシート名に使えない文字の除去、31文字制限、空→'Sheet'に置き換え。
    禁止文字: : \ / ? * [ ]
    """
    name = re.sub(r'[:\\/\\?\\*\\[\\]]', '_', str(name))
    name = name.replace("'", "’")  # HYPERLINK参照のためシングルクォートは避ける
    name = name.strip() or "Sheet"
    return name[:31]

def unique_name(base: str, used: set) -> str:
    """同名シート回避（末尾に _2, _3 ...）"""
    name = base
    i = 2
    while name in used:
        suffix = f"_{i}"
        name = (base[:(31 - len(suffix))] + suffix) if len(base) + len(suffix) > 31 else base + suffix
        i += 1
    used.add(name)
    return name

def best_fit_widths(df: pd.DataFrame, max_width=60):
    """簡易オートフィット（先頭500行の文字数から概算）"""
    widths = []
    sample = df.head(500)
    for col in df.columns:
        max_len = max([len(str(col))] + [len(str(v)) for v in sample[col].tolist()])
        widths.append(min(max_len + 2, max_width))  # 全角考慮で +2
    return widths

# === データ読み込み ===
df = pd.read_excel(SRC_FILE, sheet_name=SRC_SHEET)

# カテゴリ欠損は除外（必要ならここをコメントアウト）
df = df.copy()
df["不良カテゴリ"] = df["不良カテゴリ"].astype(str)
df = df[df["不良カテゴリ"].notna() & (df["不良カテゴリ"].str.strip() != "")]

# === 集計（カテゴリ別件数・割合） ===
counts = df["不良カテゴリ"].value_counts(dropna=False)
total = int(counts.sum())
summary = (
    counts.rename("件数")
    .to_frame()
    .assign(割合=lambda x: (x["件数"] / total * 100).round(1))
    .reset_index()
    .rename(columns={"index": "不良カテゴリ"})
)

# === Excel書き出し ===
with pd.ExcelWriter(OUT_FILE, engine="xlsxwriter") as writer:
    workbook  = writer.book

    # 1) 一覧シート
    summary_sheet = "カテゴリ一覧"
    summary.to_excel(writer, index=False, sheet_name=summary_sheet)
    ws_summary = writer.sheets[summary_sheet]

    # 列幅調整
    widths = best_fit_widths(summary)
    for i, w in enumerate(widths):
        ws_summary.set_column(i, i, w)

    # 数値書式
    fmt_int = workbook.add_format({"num_format": "#,##0"})
    fmt_pct = workbook.add_format({"num_format": "0.0\"%\""})
    ws_summary.set_column(1, 1, None, fmt_int)  # 件数
    ws_summary.set_column(2, 2, None, fmt_pct)  # 割合

    # 2) カテゴリごとにシート作成 + ハイパーリンク
    used_names = set()
    link_col = 3  # 一覧シートのD列にリンク列を作る
    ws_summary.write(0, link_col, "シートへ")  # 見出し

    for r, row in summary.iterrows():
        category = row["不良カテゴリ"]
        cat_df = df[df["不良カテゴリ"] == category].reset_index(drop=True)

        # シート名を安全化 + 重複回避
        base = sanitize_sheet_name(category)
        sheet_name = unique_name(base, used_names)

        # シート書き出し
        cat_df.to_excel(writer, index=False, sheet_name=sheet_name)
        ws = writer.sheets[sheet_name]

        # フィルタ、ヘッダ固定、列幅
        ws.autofilter(0, 0, len(cat_df), len(cat_df.columns) - 1)
        ws.freeze_panes(1, 0)
        widths_cat = best_fit_widths(cat_df)
        for i, w in enumerate(widths_cat):
            ws.set_column(i, i, w)

        # 一覧から該当シートA1へ飛ぶハイパーリンク（→ジャンプ）
        link_formula = f"=HYPERLINK(\"#'{sheet_name}'!A1\",\"→ジャンプ\")"
        ws_summary.write(r + 1, link_col, link_formula)

    # 一覧シートのヘッダ固定
    ws_summary.freeze_panes(1, 0)

print(f"✅ 出力完了: {OUT_FILE} （{len(summary)}カテゴリ, 合計 {total} 件）")

オプション：Excel内に円グラフも埋め込みたい場合

カテゴリ一覧シートに 円グラフ（件数＋%表示） を載せたい場合、with pd.ExcelWriter(...) の中で、次のブロックを 一覧の書き出し後 に追加します。

    # --- 円グラフ（カテゴリ一覧シートに埋め込み） ---
    chart_pie = workbook.add_chart({"type": "pie"})
    # A列=不良カテゴリ, B列=件数（ヘッダを除くデータ範囲）
    last_row = len(summary)  # データ行数
    chart_pie.add_series({
        "categories": [summary_sheet, 1, 0, last_row, 0],
        "values":     [summary_sheet, 1, 1, last_row, 1],
        "name": "不良カテゴリ割合",
        "data_labels": {
            "value": True,          # 件数
            "percentage": True,     # %
            "separator": "\n",      # 改行で分ける
            "leader_lines": True
        },
    })
    chart_pie.set_title({"name": "不良カテゴリ割合"})
    ws_summary.insert_chart("F2", chart_pie)  # 挿入位置は適宜調整


PNG画像としても必要な場合は、従来どおり matplotlib で保存して構いません（Excel貼付と併用可能）。

トラブルシュート

シート名エラー：: \ / ? * [ ] は使えません。本スクリプトは自動で _ に置換します。31文字超は切り詰めます。同名は _2, _3 ... を自動付与。

カテゴリが空欄の行も必要：df = df[...] のフィルタ部分をコメントアウトしてください。

フォント/日本語文字化け（グラフ用）：グラフを matplotlib で作る場合は、日本語フォントの指定（Yu Gothic/Meiryo/Noto Sans CJK JPなど）が必要です。

変更履歴メモ

v1.0: 初版。カテゴリ別シート分割、一覧シート（件数・割合・リンク）、簡易オートフィット、ヘッダ固定、フィルタ対応。

v1.1: オプションで円グラフ埋め込みに対応。
