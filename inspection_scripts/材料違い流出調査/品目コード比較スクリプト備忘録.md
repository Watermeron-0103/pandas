
## 1. Excelファイルを読み込む

```python
df_flag_raw = read_all_sheets(FLAG_PATH)
df_list_raw = read_all_sheets(LIST_PATH)
```

* **df\_flag\_raw** … 「調査(2024)\_品目コード\_サプライヤ一覧.xlsx」から全部のシートを縦にまとめたデータ
* **df\_list\_raw** … 「一致品目抽出.xlsx」から同じように読み込んだデータ

→ 複数シートでも全部つなげて比較できるようにしています。

---

## 2. 列名を特定する

```python
item_f_col = find_col(df_flag_raw, ITEM_CAND)
supp_f_col = find_col(df_flag_raw, SUPP_CAND)
flag_f_col = find_col(df_flag_raw, FLAG_CAND)
```

* 「品目コード」「サプライヤ」「部番照合フラグ」を表す列を探しています。
* `ITEM_CAND` などのリストを用意して、候補のどれかに一致した列を使う仕組み。

---

## 3. データをクリーニング

```python
df_flag[item_f_col] = clean_str_series(df_flag[item_f_col])
df_flag[supp_f_col] = clean_str_series(df_flag[supp_f_col])
df_flag[flag_f_col] = to_flag_series(df_flag[flag_f_col])
```

* 空白を削除 (`" A123 "` → `"A123"`)
* `NaN` を空文字に変換
* フラグ列を **1 または 0** に正規化

---

## 4. 照合用のキーを作成

```python
df_flag["__key_relax__"]  = df_flag[item_f_col]   # 品目コードだけ
df_flag["__key_strict__"] = df_flag[item_f_col] + "||" + df_flag[supp_f_col]  # 品目+サプライヤ
```

* **relaxキー** … 品目コードだけ
* **strictキー** … 品目コード + サプライヤの組み合わせ

同じように `df_list` 側にもキーを作って集合にします。

---

## 5. 照合ロジック

```python
def judge(row):
    if row[flag_f_col] == 1:
        return (row["__key_relax__"] in relax_set, "品目コードのみ")
    else:
        return (row["__key_strict__"] in strict_set, "品目+サプライヤ")
```

* フラグが **1** のとき → 品目コードだけで一致判定
* フラグが **0** のとき → 品目コード＋サプライヤの両方で一致判定

結果を `__一致__`（True/False）列と `__照合条件__`（判定方法の文字列）として追加。

---

## 6. 一致／不一致に分ける

```python
一致_df   = df_flag[df_flag["__一致__"] == True][out_cols].copy()
不一致_df = df_flag[df_flag["__一致__"] == False][out_cols].copy()
```

* 一致 → 条件を満たした行
* 不一致 → 条件を満たさなかった行

---

## 7. Excelに出力

```python
with pd.ExcelWriter(out_path, engine="xlsxwriter") as ew:
    一致_df.to_excel(ew, sheet_name="一致", index=False)
    不一致_df.to_excel(ew, sheet_name="不一致", index=False)
    df_list[[item_l_col, supp_l_col, "__元シート__", "__key_relax__", "__key_strict__"]] \
        .to_excel(ew, sheet_name="参照（df_list）", index=False)
```

* シート1 → 一致
* シート2 → 不一致
* シート3 → 参照（df\_listの証跡）

---

## 全体のイメージ

1. Excel読込 → 全シート結合
2. 列名を自動検出（表記ゆらぎ対応）
3. 品目コード・サプライヤ・フラグ列を整形
4. フラグに応じて一致条件を切替
5. 一致・不一致に仕分け
6. Excelにまとめて出力

---

## 完全なコード
```python
# -*- coding: utf-8 -*-
"""
df_flag と df_list を突合し、フラグに応じた条件で一致/不一致に振り分けてExcel出力するスクリプト
- フラグ==1: 品目コードだけ一致でOK
- フラグ==0: 品目コード + サプライヤ の両方が一致でOK
"""

import pandas as pd
from datetime import datetime
from pathlib import Path

# ==== 入力パス（必要に応じて書き換え） ====
FLAG_PATH = "out/調査(2024)_品目コード_サプライヤ一覧.xlsx"
LIST_PATH = "out/一致品目抽出.xlsx"
# 出力先（未指定なら /out の隣に作成）
OUTPUT_DIR = Path("out")

# 列名の候補（ゆらぎを吸収）
ITEM_CAND = ["品目コード", "品目ｺｰﾄﾞ", "品目", "部品番号", "品番", "品目CD"]
SUPP_CAND = ["サプライヤ", "ｻﾌﾟﾗｲﾔ", "サプライヤー", "仕入先", "Supplier"]
FLAG_CAND = ["部番照合フラグ", "部番照合ﾌﾗｸﾞ", "照合フラグ", "フラグ"]

def read_all_sheets(path: str, add_src_sheet_col: bool = True) -> pd.DataFrame:
    """Excelの全シートを縦結合して返す（文字列で読み込む）"""
    dfs = pd.read_excel(path, sheet_name=None, dtype=str)
    out = []
    for sheet, df in dfs.items():
        df = df.copy()
        if add_src_sheet_col:
            df["__元シート__"] = sheet
        out.append(df)
    return pd.concat(out, ignore_index=True) if out else pd.DataFrame()

def find_col(df: pd.DataFrame, candidates: list[str]) -> str:
    """候補リストから最も合致する列名を返す（完全一致→部分一致）"""
    # 完全一致
    for cand in candidates:
        if cand in df.columns:
            return cand
    # 部分一致
    for cand in candidates:
        for col in df.columns:
            if cand in col:
                return col
    raise KeyError(f"列が見つかりません: {candidates} in {list(df.columns)}")

def clean_str_series(s: pd.Series) -> pd.Series:
    """両端空白除去 + NaN→空文字"""
    return s.fillna("").astype(str).str.strip()

def to_flag_series(s: pd.Series) -> pd.Series:
    """1/0に正規化（それ以外の値は0扱い）"""
    def _to_flag(v):
        try:
            return 1 if int(str(v).strip()) == 1 else 0
        except Exception:
            return 0
    return s.map(_to_flag)

def main():
    OUTPUT_DIR.mkdir(parents=True, exist_ok=True)

    # --- 入力読込 ---
    df_flag_raw = read_all_sheets(FLAG_PATH)
    df_list_raw = read_all_sheets(LIST_PATH)

    # --- 列名特定 ---
    item_f_col = find_col(df_flag_raw, ITEM_CAND)
    supp_f_col = find_col(df_flag_raw, SUPP_CAND)
    flag_f_col = find_col(df_flag_raw, FLAG_CAND)

    item_l_col = find_col(df_list_raw, ITEM_CAND)
    supp_l_col = find_col(df_list_raw, SUPP_CAND)

    # --- クリーニング ---
    df_flag = df_flag_raw.copy()
    df_flag[item_f_col] = clean_str_series(df_flag[item_f_col])
    df_flag[supp_f_col] = clean_str_series(df_flag[supp_f_col])
    df_flag[flag_f_col] = to_flag_series(df_flag[flag_f_col])

    df_list = df_list_raw.copy()
    df_list[item_l_col] = clean_str_series(df_list[item_l_col])
    df_list[supp_l_col] = clean_str_series(df_list[supp_l_col])

    # --- 照合キー作成 ---
    df_flag["__key_relax__"]  = df_flag[item_f_col]
    df_flag["__key_strict__"] = df_flag[item_f_col] + "||" + df_flag[supp_f_col]

    df_list["__key_relax__"]  = df_list[item_l_col]
    df_list["__key_strict__"] = df_list[item_l_col] + "||" + df_list[supp_l_col]

    relax_set  = set(df_list["__key_relax__"].unique())
    strict_set = set(df_list["__key_strict__"].unique())

    # --- マッチ判定 ---
    def judge(row):
        if row[flag_f_col] == 1:
            return (row["__key_relax__"] in relax_set, "品目コードのみ")
        else:
            return (row["__key_strict__"] in strict_set, "品目+サプライヤ")

    matched, cond = zip(*df_flag.apply(judge, axis=1))
    df_flag["__一致__"] = matched
    df_flag["__照合条件__"] = cond

    # --- 出力用列順（存在するもののみ） ---
    out_cols = [item_f_col, supp_f_col, flag_f_col, "__照合条件__", "__一致__", "__元シート__"]
    out_cols = [c for c in out_cols if c in df_flag.columns]

    一致_df = df_flag[df_flag["__一致__"] == True][out_cols].copy()
    不一致_df = df_flag[df_flag["__一致__"] == False][out_cols].copy()

    # --- 出力 ---
    ts = datetime.now().strftime("%Y%m%d_%H%M%S")
    out_path = OUTPUT_DIR / f"比較結果_品目コード_サプライヤ_{ts}.xlsx"

    with pd.ExcelWriter(out_path, engine="xlsxwriter") as ew:
        一致_df.to_excel(ew, sheet_name="一致", index=False)
        不一致_df.to_excel(ew, sheet_name="不一致", index=False)
        df_list[[item_l_col, supp_l_col, "__元シート__", "__key_relax__", "__key_strict__"]].to_excel(
            ew, sheet_name="参照（df_list）", index=False
        )

    print(f"出力完了: {out_path}")

if __name__ == "__main__":
    main()
```

---


💡 だから、スクリプトの役割は「2つのExcelを突き合わせて、**フラグに応じて一致条件を変えつつ、結果を整理してExcel出力する**」ということです。


