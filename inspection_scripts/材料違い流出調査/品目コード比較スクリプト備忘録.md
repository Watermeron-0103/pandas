# 品目コード比較スクリプト備忘録

## 概要

このスクリプトは、複数の Excel ファイルから読み込んだ**品目コード・サプライヤ一覧**を筋合わせて、
部番照合フラグの値に応じて一致するレコードと一致しないレコードに振り分け、結果を Excel 形式で出力するためのものです。元の Excel ファイルは複数シート構成でも扱えるように**全シートを縦に連結**して処理します。

## 入力ファイル

- 調査(2024)_品目コード_サプライヤ一覧.xlsx … 比較対象となる一覧。各行に品目コード、サプライヤ、部番照合フラグが含まれている。複数シートある場合は縦結合して処理。
- 一致品目抽出.xlsx … 照合用の基準リスト。こちらも複数シートを縦結合して利用する。

## 処理の流れ

1. **全シート読み込み**  
   pandas.read_excel(..., sheet_name=None) を使い、全シートを諸定として取得し、pandas.concat で縦結合する。元シート名は __元シート__ 列として保持。

2. **列名の自動検出**  
   現場や年度により列名表記が振れるため、候補一覧から既存列名を検索し、適合する列を採用する。  
   - 品目コード: 品目コード、品目ｺｰﾄﾞ、品目、部品番号、品番、品目CD など  
   - サプライヤ: サプライヤ、ｻプライヤ、サプライヤー、仕入先、Supplier など  
   - 部番照合フラグ: 部番照合フラグ、部番照合ﾌラグ、照合フラグ、フラグ など  

3. **データのクレンジング**  
   文字列列は両端の空白を除去し、NaN を空文字に変換。  
   部番照合フラグは数値／文字列を問わず 1 または 0 に正規化する。

4. **照合キーの作成**  
   - 粗いキー (__key_relax__) : 品目コードのみ。フラグが 1 の場合はこちらを使って照合。  
   - 厳格なキー (__key_strict__) : 品目コードとサプライヤを連続したもの（区分りに `||` を使用）。フラグが 0 の場合はこちらを使って照合。  
   基準リスト側にも同様のキーを作成し、集合として保持。

5. **一致判定**  
   各行について部番照合フラグを参照し、以下の条件で一致／不一致を判定する。  
   - フラグが 1: 品目コードだけ一致していれば一致  
   - フラグが 0: 品目コードとサプライヤの両方が一致していれば一致  
   判定結果は __一致__ 列（True/False）として保持し、照合条件種別も __照合条件__ 列に記録。

6. **結果の分割と出力**  
   一致した行と一致しなかった行をそれぞれ抽出して別シートに出力する。  
   出力ファイルには以下の3シートを含める：  
   1. 一致 … 条件を満たした行  
   2. 不一致 … 条件を満たさなかった行  
   3. 参照（df_list） … 基準リストの証跡用。品目コード・サプライヤ・元シート名・キーを出力  

## 使い方

1. 必要なライブラリをインストールします（未インストールの場合）：  
   
       pip install pandas openpyxl xlsxwriter

2. スクリプト内の入力ファイルパス（FLAG_PATH, LIST_PATH）と出力先ディレクトリ（OUTPUT_DIR）を適宜書き換えます。

3. スクリプトを実行すると、カレントディレクトリに日時入りのファイル名で結果 Excel（比較結果_品目コード_サプライヤ_YYYYMMDD_HHMMSS.xlsx）が作成されます。  
   
       python compare_items_suppliers.py

## 列名候補を多く持たせる理由

Excel ファイルは担当者や部署、年度によって同じ意味の列でも表記が異なることが多いからです。例えば、品目コードを「品番」と略したり、サプライヤを「仕入先」と表記したり、半角カナが使われたりするケースがあります。候補リストを用意しておくことで、多少異なる列名でも同じ処理ロジックを適用できるようにしています。列名が固定であれば候補リストを削除して直接指定して構いません。

## 改良ポイント例

- フラグ以外の条件追加: 将来的にさらに複雑な条件（例えば有効日付や数量）を加えたい場合、照合キーを柔軟に組み合わせられるよう関数化すると便利です。  
- 重複排除: 基準リスト側に重複が多い場合、事前に drop_duplicates を行うと照合集合のサイズを削減できます。  
- ファイル出力形式: CSV や JSON など他形式での出力を追加することも容易です。  

## まとめ

このスクリプトは、品目コードとサプライヤの一覧をフラグに応じて柔軟に突合し、結果を分かりやすく分類して出力するツールです。列名のゆらぎに対応しつつ、複数シートもまとめて処理できるよう設計されているため、実務で頻繁に使う Excel 照合業務の効率化に役立ちます。
