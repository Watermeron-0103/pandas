
## 1. Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€

```python
df_flag_raw = read_all_sheets(FLAG_PATH)
df_list_raw = read_all_sheets(LIST_PATH)
```

* **df\_flag\_raw** â€¦ ã€Œèª¿æŸ»(2024)\_å“ç›®ã‚³ãƒ¼ãƒ‰\_ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ä¸€è¦§.xlsxã€ã‹ã‚‰å…¨éƒ¨ã®ã‚·ãƒ¼ãƒˆã‚’ç¸¦ã«ã¾ã¨ã‚ãŸãƒ‡ãƒ¼ã‚¿
* **df\_list\_raw** â€¦ ã€Œä¸€è‡´å“ç›®æŠ½å‡º.xlsxã€ã‹ã‚‰åŒã˜ã‚ˆã†ã«èª­ã¿è¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿

â†’ è¤‡æ•°ã‚·ãƒ¼ãƒˆã§ã‚‚å…¨éƒ¨ã¤ãªã’ã¦æ¯”è¼ƒã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

---

## 2. åˆ—åã‚’ç‰¹å®šã™ã‚‹

```python
item_f_col = find_col(df_flag_raw, ITEM_CAND)
supp_f_col = find_col(df_flag_raw, SUPP_CAND)
flag_f_col = find_col(df_flag_raw, FLAG_CAND)
```

* ã€Œå“ç›®ã‚³ãƒ¼ãƒ‰ã€ã€Œã‚µãƒ—ãƒ©ã‚¤ãƒ¤ã€ã€Œéƒ¨ç•ªç…§åˆãƒ•ãƒ©ã‚°ã€ã‚’è¡¨ã™åˆ—ã‚’æ¢ã—ã¦ã„ã¾ã™ã€‚
* `ITEM_CAND` ãªã©ã®ãƒªã‚¹ãƒˆã‚’ç”¨æ„ã—ã¦ã€å€™è£œã®ã©ã‚Œã‹ã«ä¸€è‡´ã—ãŸåˆ—ã‚’ä½¿ã†ä»•çµ„ã¿ã€‚

---

## 3. ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°

```python
df_flag[item_f_col] = clean_str_series(df_flag[item_f_col])
df_flag[supp_f_col] = clean_str_series(df_flag[supp_f_col])
df_flag[flag_f_col] = to_flag_series(df_flag[flag_f_col])
```

* ç©ºç™½ã‚’å‰Šé™¤ (`" A123 "` â†’ `"A123"`)
* `NaN` ã‚’ç©ºæ–‡å­—ã«å¤‰æ›
* ãƒ•ãƒ©ã‚°åˆ—ã‚’ **1 ã¾ãŸã¯ 0** ã«æ­£è¦åŒ–

---

## 4. ç…§åˆç”¨ã®ã‚­ãƒ¼ã‚’ä½œæˆ

```python
df_flag["__key_relax__"]  = df_flag[item_f_col]   # å“ç›®ã‚³ãƒ¼ãƒ‰ã ã‘
df_flag["__key_strict__"] = df_flag[item_f_col] + "||" + df_flag[supp_f_col]  # å“ç›®+ã‚µãƒ—ãƒ©ã‚¤ãƒ¤
```

* **relaxã‚­ãƒ¼** â€¦ å“ç›®ã‚³ãƒ¼ãƒ‰ã ã‘
* **strictã‚­ãƒ¼** â€¦ å“ç›®ã‚³ãƒ¼ãƒ‰ + ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ã®çµ„ã¿åˆã‚ã›

åŒã˜ã‚ˆã†ã« `df_list` å´ã«ã‚‚ã‚­ãƒ¼ã‚’ä½œã£ã¦é›†åˆã«ã—ã¾ã™ã€‚

---

## 5. ç…§åˆãƒ­ã‚¸ãƒƒã‚¯

```python
def judge(row):
    if row[flag_f_col] == 1:
        return (row["__key_relax__"] in relax_set, "å“ç›®ã‚³ãƒ¼ãƒ‰ã®ã¿")
    else:
        return (row["__key_strict__"] in strict_set, "å“ç›®+ã‚µãƒ—ãƒ©ã‚¤ãƒ¤")
```

* ãƒ•ãƒ©ã‚°ãŒ **1** ã®ã¨ã â†’ å“ç›®ã‚³ãƒ¼ãƒ‰ã ã‘ã§ä¸€è‡´åˆ¤å®š
* ãƒ•ãƒ©ã‚°ãŒ **0** ã®ã¨ã â†’ å“ç›®ã‚³ãƒ¼ãƒ‰ï¼‹ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ã®ä¸¡æ–¹ã§ä¸€è‡´åˆ¤å®š

çµæœã‚’ `__ä¸€è‡´__`ï¼ˆTrue/Falseï¼‰åˆ—ã¨ `__ç…§åˆæ¡ä»¶__`ï¼ˆåˆ¤å®šæ–¹æ³•ã®æ–‡å­—åˆ—ï¼‰ã¨ã—ã¦è¿½åŠ ã€‚

---

## 6. ä¸€è‡´ï¼ä¸ä¸€è‡´ã«åˆ†ã‘ã‚‹

```python
ä¸€è‡´_df   = df_flag[df_flag["__ä¸€è‡´__"] == True][out_cols].copy()
ä¸ä¸€è‡´_df = df_flag[df_flag["__ä¸€è‡´__"] == False][out_cols].copy()
```

* ä¸€è‡´ â†’ æ¡ä»¶ã‚’æº€ãŸã—ãŸè¡Œ
* ä¸ä¸€è‡´ â†’ æ¡ä»¶ã‚’æº€ãŸã•ãªã‹ã£ãŸè¡Œ

---

## 7. Excelã«å‡ºåŠ›

```python
with pd.ExcelWriter(out_path, engine="xlsxwriter") as ew:
    ä¸€è‡´_df.to_excel(ew, sheet_name="ä¸€è‡´", index=False)
    ä¸ä¸€è‡´_df.to_excel(ew, sheet_name="ä¸ä¸€è‡´", index=False)
    df_list[[item_l_col, supp_l_col, "__å…ƒã‚·ãƒ¼ãƒˆ__", "__key_relax__", "__key_strict__"]] \
        .to_excel(ew, sheet_name="å‚ç…§ï¼ˆdf_listï¼‰", index=False)
```

* ã‚·ãƒ¼ãƒˆ1 â†’ ä¸€è‡´
* ã‚·ãƒ¼ãƒˆ2 â†’ ä¸ä¸€è‡´
* ã‚·ãƒ¼ãƒˆ3 â†’ å‚ç…§ï¼ˆdf\_listã®è¨¼è·¡ï¼‰

---

## å…¨ä½“ã®ã‚¤ãƒ¡ãƒ¼ã‚¸

1. Excelèª­è¾¼ â†’ å…¨ã‚·ãƒ¼ãƒˆçµåˆ
2. åˆ—åã‚’è‡ªå‹•æ¤œå‡ºï¼ˆè¡¨è¨˜ã‚†ã‚‰ãå¯¾å¿œï¼‰
3. å“ç›®ã‚³ãƒ¼ãƒ‰ãƒ»ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ»ãƒ•ãƒ©ã‚°åˆ—ã‚’æ•´å½¢
4. ãƒ•ãƒ©ã‚°ã«å¿œã˜ã¦ä¸€è‡´æ¡ä»¶ã‚’åˆ‡æ›¿
5. ä¸€è‡´ãƒ»ä¸ä¸€è‡´ã«ä»•åˆ†ã‘
6. Excelã«ã¾ã¨ã‚ã¦å‡ºåŠ›

---

## å®Œå…¨ãªã‚³ãƒ¼ãƒ‰
```python
# -*- coding: utf-8 -*-
"""
df_flag ã¨ df_list ã‚’çªåˆã—ã€ãƒ•ãƒ©ã‚°ã«å¿œã˜ãŸæ¡ä»¶ã§ä¸€è‡´/ä¸ä¸€è‡´ã«æŒ¯ã‚Šåˆ†ã‘ã¦Excelå‡ºåŠ›ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
- ãƒ•ãƒ©ã‚°==1: å“ç›®ã‚³ãƒ¼ãƒ‰ã ã‘ä¸€è‡´ã§OK
- ãƒ•ãƒ©ã‚°==0: å“ç›®ã‚³ãƒ¼ãƒ‰ + ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ ã®ä¸¡æ–¹ãŒä¸€è‡´ã§OK
"""

import pandas as pd
from datetime import datetime
from pathlib import Path

# ==== å…¥åŠ›ãƒ‘ã‚¹ï¼ˆå¿…è¦ã«å¿œã˜ã¦æ›¸ãæ›ãˆï¼‰ ====
FLAG_PATH = "out/èª¿æŸ»(2024)_å“ç›®ã‚³ãƒ¼ãƒ‰_ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ä¸€è¦§.xlsx"
LIST_PATH = "out/ä¸€è‡´å“ç›®æŠ½å‡º.xlsx"
# å‡ºåŠ›å…ˆï¼ˆæœªæŒ‡å®šãªã‚‰ /out ã®éš£ã«ä½œæˆï¼‰
OUTPUT_DIR = Path("out")

# åˆ—åã®å€™è£œï¼ˆã‚†ã‚‰ãã‚’å¸åï¼‰
ITEM_CAND = ["å“ç›®ã‚³ãƒ¼ãƒ‰", "å“ç›®ï½ºï½°ï¾„ï¾", "å“ç›®", "éƒ¨å“ç•ªå·", "å“ç•ª", "å“ç›®CD"]
SUPP_CAND = ["ã‚µãƒ—ãƒ©ã‚¤ãƒ¤", "ï½»ï¾Œï¾Ÿï¾—ï½²ï¾”", "ã‚µãƒ—ãƒ©ã‚¤ãƒ¤ãƒ¼", "ä»•å…¥å…ˆ", "Supplier"]
FLAG_CAND = ["éƒ¨ç•ªç…§åˆãƒ•ãƒ©ã‚°", "éƒ¨ç•ªç…§åˆï¾Œï¾—ï½¸ï¾", "ç…§åˆãƒ•ãƒ©ã‚°", "ãƒ•ãƒ©ã‚°"]

def read_all_sheets(path: str, add_src_sheet_col: bool = True) -> pd.DataFrame:
    """Excelã®å…¨ã‚·ãƒ¼ãƒˆã‚’ç¸¦çµåˆã—ã¦è¿”ã™ï¼ˆæ–‡å­—åˆ—ã§èª­ã¿è¾¼ã‚€ï¼‰"""
    dfs = pd.read_excel(path, sheet_name=None, dtype=str)
    out = []
    for sheet, df in dfs.items():
        df = df.copy()
        if add_src_sheet_col:
            df["__å…ƒã‚·ãƒ¼ãƒˆ__"] = sheet
        out.append(df)
    return pd.concat(out, ignore_index=True) if out else pd.DataFrame()

def find_col(df: pd.DataFrame, candidates: list[str]) -> str:
    """å€™è£œãƒªã‚¹ãƒˆã‹ã‚‰æœ€ã‚‚åˆè‡´ã™ã‚‹åˆ—åã‚’è¿”ã™ï¼ˆå®Œå…¨ä¸€è‡´â†’éƒ¨åˆ†ä¸€è‡´ï¼‰"""
    # å®Œå…¨ä¸€è‡´
    for cand in candidates:
        if cand in df.columns:
            return cand
    # éƒ¨åˆ†ä¸€è‡´
    for cand in candidates:
        for col in df.columns:
            if cand in col:
                return col
    raise KeyError(f"åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {candidates} in {list(df.columns)}")

def clean_str_series(s: pd.Series) -> pd.Series:
    """ä¸¡ç«¯ç©ºç™½é™¤å» + NaNâ†’ç©ºæ–‡å­—"""
    return s.fillna("").astype(str).str.strip()

def to_flag_series(s: pd.Series) -> pd.Series:
    """1/0ã«æ­£è¦åŒ–ï¼ˆãã‚Œä»¥å¤–ã®å€¤ã¯0æ‰±ã„ï¼‰"""
    def _to_flag(v):
        try:
            return 1 if int(str(v).strip()) == 1 else 0
        except Exception:
            return 0
    return s.map(_to_flag)

def main():
    OUTPUT_DIR.mkdir(parents=True, exist_ok=True)

    # --- å…¥åŠ›èª­è¾¼ ---
    df_flag_raw = read_all_sheets(FLAG_PATH)
    df_list_raw = read_all_sheets(LIST_PATH)

    # --- åˆ—åç‰¹å®š ---
    item_f_col = find_col(df_flag_raw, ITEM_CAND)
    supp_f_col = find_col(df_flag_raw, SUPP_CAND)
    flag_f_col = find_col(df_flag_raw, FLAG_CAND)

    item_l_col = find_col(df_list_raw, ITEM_CAND)
    supp_l_col = find_col(df_list_raw, SUPP_CAND)

    # --- ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚° ---
    df_flag = df_flag_raw.copy()
    df_flag[item_f_col] = clean_str_series(df_flag[item_f_col])
    df_flag[supp_f_col] = clean_str_series(df_flag[supp_f_col])
    df_flag[flag_f_col] = to_flag_series(df_flag[flag_f_col])

    df_list = df_list_raw.copy()
    df_list[item_l_col] = clean_str_series(df_list[item_l_col])
    df_list[supp_l_col] = clean_str_series(df_list[supp_l_col])

    # --- ç…§åˆã‚­ãƒ¼ä½œæˆ ---
    df_flag["__key_relax__"]  = df_flag[item_f_col]
    df_flag["__key_strict__"] = df_flag[item_f_col] + "||" + df_flag[supp_f_col]

    df_list["__key_relax__"]  = df_list[item_l_col]
    df_list["__key_strict__"] = df_list[item_l_col] + "||" + df_list[supp_l_col]

    relax_set  = set(df_list["__key_relax__"].unique())
    strict_set = set(df_list["__key_strict__"].unique())

    # --- ãƒãƒƒãƒåˆ¤å®š ---
    def judge(row):
        if row[flag_f_col] == 1:
            return (row["__key_relax__"] in relax_set, "å“ç›®ã‚³ãƒ¼ãƒ‰ã®ã¿")
        else:
            return (row["__key_strict__"] in strict_set, "å“ç›®+ã‚µãƒ—ãƒ©ã‚¤ãƒ¤")

    matched, cond = zip(*df_flag.apply(judge, axis=1))
    df_flag["__ä¸€è‡´__"] = matched
    df_flag["__ç…§åˆæ¡ä»¶__"] = cond

    # --- å‡ºåŠ›ç”¨åˆ—é †ï¼ˆå­˜åœ¨ã™ã‚‹ã‚‚ã®ã®ã¿ï¼‰ ---
    out_cols = [item_f_col, supp_f_col, flag_f_col, "__ç…§åˆæ¡ä»¶__", "__ä¸€è‡´__", "__å…ƒã‚·ãƒ¼ãƒˆ__"]
    out_cols = [c for c in out_cols if c in df_flag.columns]

    ä¸€è‡´_df = df_flag[df_flag["__ä¸€è‡´__"] == True][out_cols].copy()
    ä¸ä¸€è‡´_df = df_flag[df_flag["__ä¸€è‡´__"] == False][out_cols].copy()

    # --- å‡ºåŠ› ---
    ts = datetime.now().strftime("%Y%m%d_%H%M%S")
    out_path = OUTPUT_DIR / f"æ¯”è¼ƒçµæœ_å“ç›®ã‚³ãƒ¼ãƒ‰_ã‚µãƒ—ãƒ©ã‚¤ãƒ¤_{ts}.xlsx"

    with pd.ExcelWriter(out_path, engine="xlsxwriter") as ew:
        ä¸€è‡´_df.to_excel(ew, sheet_name="ä¸€è‡´", index=False)
        ä¸ä¸€è‡´_df.to_excel(ew, sheet_name="ä¸ä¸€è‡´", index=False)
        df_list[[item_l_col, supp_l_col, "__å…ƒã‚·ãƒ¼ãƒˆ__", "__key_relax__", "__key_strict__"]].to_excel(
            ew, sheet_name="å‚ç…§ï¼ˆdf_listï¼‰", index=False
        )

    print(f"å‡ºåŠ›å®Œäº†: {out_path}")

if __name__ == "__main__":
    main()
```

---


ğŸ’¡ ã ã‹ã‚‰ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å½¹å‰²ã¯ã€Œ2ã¤ã®Excelã‚’çªãåˆã‚ã›ã¦ã€**ãƒ•ãƒ©ã‚°ã«å¿œã˜ã¦ä¸€è‡´æ¡ä»¶ã‚’å¤‰ãˆã¤ã¤ã€çµæœã‚’æ•´ç†ã—ã¦Excelå‡ºåŠ›ã™ã‚‹**ã€ã¨ã„ã†ã“ã¨ã§ã™ã€‚


